<?php
// contact.php - Sistema de envio de emails com AJAX e SweetAlert 2
// MegaTech - Sistema de contato

require_once 'vendor/autoload.php'; // Composer autoload para PHPMailer

use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\SMTP;
use PHPMailer\PHPMailer\Exception;

// Configura√ß√µes do email - CONFIGURE ESTAS VARI√ÅVEIS
$config = [
    // Configura√ß√µes SMTP
    'smtp_host' => 'smtp.gmail.com', // ou smtp do seu provedor
    'smtp_port' => 587,
    'smtp_secure' => PHPMailer::ENCRYPTION_STARTTLS,
    'smtp_username' => 'mauro.cardoso.1998@gmail.com', // Seu email
    'smtp_password' => 'lndsutpoplwoyvuu', // Senha de app do Gmail ou senha normal

    // Configura√ß√µes do destinat√°rio
    'to_email' => 'devmaurofelix@gmail.com',
    'to_name' => 'MegaTech',

    // Configura√ß√µes do remetente
    'from_email' => 'mauro.cardoso.1998@gmail.com',
    'from_name' => 'Site MegaTech',

    // URL de redirecionamento ap√≥s envio (fallback para JS desabilitado)
    'success_redirect' => 'contato.html?success=1',
    'error_redirect' => 'contato.html?error=1'
];

// Fun√ß√£o para retornar resposta JSON
function sendJsonResponse($success, $message, $data = [])
{
    header('Content-Type: application/json; charset=utf-8');
    echo json_encode([
        'success' => $success,
        'message' => $message,
        'data' => $data
    ], JSON_UNESCAPED_UNICODE);
    exit;
}

// Fun√ß√£o para verificar se √© uma requisi√ß√£o AJAX
function isAjaxRequest()
{
    return !empty($_SERVER['HTTP_X_REQUESTED_WITH']) &&
        strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest';
}

// Fun√ß√£o para limpar dados de entrada
function sanitizeInput($data)
{
    $data = trim($data);
    $data = stripslashes($data);
    $data = htmlspecialchars($data);
    return $data;
}

// Fun√ß√£o para validar email
function validateEmail($email)
{
    return filter_var($email, FILTER_VALIDATE_EMAIL);
}

// Fun√ß√£o para validar telefone brasileiro
function validatePhone($phone)
{
    $phone = preg_replace('/[^0-9]/', '', $phone);
    return strlen($phone) >= 10 && strlen($phone) <= 11;
}

// Verificar se √© uma requisi√ß√£o POST
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    if (isAjaxRequest()) {
        sendJsonResponse(false, 'M√©todo de requisi√ß√£o inv√°lido');
    } else {
        header('Location: ' . $config['error_redirect']);
        exit;
    }
}

// Capturar e sanitizar dados do formul√°rio
$nome = sanitizeInput($_POST['nome_completo'] ?? ''); // Note o espa√ßo extra no name
$telefone = sanitizeInput($_POST['telefone'] ?? '');
$email = sanitizeInput($_POST['email'] ?? '');
$cidade = sanitizeInput($_POST['tidade'] ?? '');
$como_encontrou = sanitizeInput($_POST['com_nos_encontrou'] ?? '');
$mensagem = sanitizeInput($_POST['mensagem'] ?? '');

// Array de erros
$errors = [];

// Valida√ß√µes
if (empty($nome)) {
    $errors[] = 'Nome completo √© obrigat√≥rio';
}

if (empty($telefone)) {
    $errors[] = 'Telefone √© obrigat√≥rio';
} elseif (!validatePhone($telefone)) {
    $errors[] = 'Telefone deve conter entre 10 e 11 d√≠gitos';
}

if (empty($email)) {
    $errors[] = 'E-mail √© obrigat√≥rio';
} elseif (!validateEmail($email)) {
    $errors[] = 'E-mail inv√°lido';
}

if (empty($cidade)) {
    $errors[] = 'Cidade √© obrigat√≥ria';
}

if (empty($como_encontrou)) {
    $errors[] = 'Campo "Como nos encontrou" √© obrigat√≥rio';
}

if (empty($mensagem)) {
    $errors[] = 'Mensagem √© obrigat√≥ria';
} elseif (strlen($mensagem) < 10) {
    $errors[] = 'Mensagem deve ter pelo menos 10 caracteres';
}

// Se houver erros
if (!empty($errors)) {
    $error_msg = implode(', ', $errors);

    if (isAjaxRequest()) {
        sendJsonResponse(false, $error_msg, ['errors' => $errors]);
    } else {
        header('Location: ' . $config['error_redirect'] . '&msg=' . urlencode($error_msg));
        exit;
    }
}

// Mapear valores do select "Como nos encontrou"
$como_encontrou_map = [
    'google' => 'Google / Pesquisa Online',
    'instagram' => 'Instagram',
    'facebook' => 'Facebook',
    'whatsapp' => 'WhatsApp',
    'indicacao' => 'Indica√ß√£o de Amigos/Fam√≠lia',
    'anuncio' => 'An√∫ncio/Propaganda',
    'passando' => 'Passando na Loja',
    'outros' => 'Outros'
];

$como_encontrou_texto = $como_encontrou_map[$como_encontrou] ?? $como_encontrou;

// Valida√ß√µes extras de seguran√ßa
if (strlen($nome) > 100) {
    $error = 'Nome muito longo (m√°ximo 100 caracteres)';
    if (isAjaxRequest()) {
        sendJsonResponse(false, $error);
    } else {
        header('Location: ' . $config['error_redirect'] . '&msg=' . urlencode($error));
        exit;
    }
}

if (strlen($mensagem) > 5000) {
    $error = 'Mensagem muito longa (m√°ximo 5000 caracteres)';
    if (isAjaxRequest()) {
        sendJsonResponse(false, $error);
    } else {
        header('Location: ' . $config['error_redirect'] . '&msg=' . urlencode($error));
        exit;
    }
}

// Prote√ß√£o contra spam (honeypot e rate limiting)
session_start();

// Rate limiting: m√°ximo 3 envios por sess√£o em 10 minutos
$current_time = time();
if (!isset($_SESSION['contact_attempts'])) {
    $_SESSION['contact_attempts'] = [];
}

// Limpar tentativas antigas (mais de 10 minutos)
$_SESSION['contact_attempts'] = array_filter($_SESSION['contact_attempts'], function ($timestamp) use ($current_time) {
    return ($current_time - $timestamp) < 600; // 10 minutos
});

if (count($_SESSION['contact_attempts']) >= 3) {
    $error = 'Muitas tentativas. Aguarde alguns minutos antes de tentar novamente.';
    if (isAjaxRequest()) {
        sendJsonResponse(false, $error);
    } else {
        header('Location: ' . $config['error_redirect'] . '&msg=' . urlencode($error));
        exit;
    }
}

try {
    // Criar inst√¢ncia do PHPMailer
    $mail = new PHPMailer(true);

    // Configura√ß√µes do servidor SMTP
    $mail->isSMTP();
    $mail->Host = $config['smtp_host'];
    $mail->SMTPAuth = true;
    $mail->Username = $config['smtp_username'];
    $mail->Password = $config['smtp_password'];
    $mail->SMTPSecure = $config['smtp_secure'];
    $mail->Port = $config['smtp_port'];

    // Configurar charset
    $mail->CharSet = 'UTF-8';
    $mail->Encoding = 'base64';

    // Destinat√°rios
    $mail->setFrom($config['from_email'], $config['from_name']);
    $mail->addAddress($config['to_email'], $config['to_name']);
    $mail->addReplyTo($email, $nome);

    // Configurar como HTML
    $mail->isHTML(true);
    $mail->Subject = 'Novo contato do site - ' . $nome;

    // Corpo do email em HTML
    $mail->Body = '
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
            .content { background: #f9f9f9; padding: 30px; }
            .field { margin-bottom: 15px; }
            .label { font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
            .value { margin-top: 5px; padding: 12px; background: white; border-left: 4px solid #3498db; border-radius: 4px; }
            .footer { background: #34495e; color: white; padding: 15px; text-align: center; font-size: 12px; border-radius: 0 0 8px 8px; }
            .highlight { background: #e8f5e8; border-left-color: #27ae60; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üìß Novo Contato - MegaTech</h1>
                <p style="margin: 0; font-size: 14px; opacity: 0.9;">Formul√°rio de contato do site</p>
            </div>
            
            <div class="content">
                <p><strong>Voc√™ recebeu uma nova mensagem atrav√©s do formul√°rio de contato do site.</strong></p>
                
                <div class="field">
                    <div class="label">üë§ Nome Completo:</div>
                    <div class="value highlight">' . htmlspecialchars($nome) . '</div>
                </div>
                
                <div class="field">
                    <div class="label">üì± Telefone:</div>
                    <div class="value">' . htmlspecialchars($telefone) . '</div>
                </div>
                
                <div class="field">
                    <div class="label">üìß E-mail:</div>
                    <div class="value">' . htmlspecialchars($email) . '</div>
                </div>
                
                <div class="field">
                    <div class="label">üèôÔ∏è Cidade:</div>
                    <div class="value">' . htmlspecialchars($cidade) . '</div>
                </div>
                
                <div class="field">
                    <div class="label">üîç Como nos encontrou:</div>
                    <div class="value">' . htmlspecialchars($como_encontrou_texto) . '</div>
                </div>
                
                <div class="field">
                    <div class="label">üí¨ Mensagem:</div>
                    <div class="value" style="white-space: pre-wrap;">' . htmlspecialchars($mensagem) . '</div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-top: 20px; border-left: 4px solid #ffc107;">
                    <h4 style="margin-top: 0; color: #856404;">‚ö° A√ß√£o Recomendada:</h4>
                    <p style="margin-bottom: 0; color: #856404;">Responder em at√© 24 horas conforme prometido no site.</p>
                </div>
            </div>
            
            <div class="footer">
                <p>üìÖ Enviado em: ' . date('d/m/Y √†s H:i:s') . '</p>
                <p>üåê IP do visitante: ' . $_SERVER['REMOTE_ADDR'] . '</p>
                <p>üñ•Ô∏è User Agent: ' . substr($_SERVER['HTTP_USER_AGENT'], 0, 100) . '</p>
                <p style="margin-top: 10px; font-weight: bold;">MegaTech - Sistema de Contato</p>
            </div>
        </div>
    </body>
    </html>';

    // Vers√£o em texto simples (fallback)
    $mail->AltBody = "=== NOVO CONTATO - MEGATECH ===\n\n"
        . "Nome: $nome\n"
        . "Telefone: $telefone\n"
        . "E-mail: $email\n"
        . "Cidade: $cidade\n"
        . "Como nos encontrou: $como_encontrou_texto\n\n"
        . "Mensagem:\n$mensagem\n\n"
        . "---\n"
        . "Enviado em: " . date('d/m/Y √†s H:i:s') . "\n"
        . "IP: " . $_SERVER['REMOTE_ADDR'];

    // Enviar email
    $mail->send();

    // Registrar tentativa bem-sucedida
    $_SESSION['contact_attempts'][] = $current_time;

    // Log de sucesso
    error_log("Contato enviado com sucesso - Nome: $nome, Email: $email, IP: " . $_SERVER['REMOTE_ADDR'], 0);

    // Enviar email de confirma√ß√£o para o cliente (opcional)
    sendConfirmationEmail($email, $nome, $config);

    // Resposta de sucesso
    if (isAjaxRequest()) {
        sendJsonResponse(true, 'Mensagem enviada com sucesso! Entraremos em contato em breve.', [
            'nome' => $nome,
            'email' => $email,
            'timestamp' => date('d/m/Y H:i:s')
        ]);
    } else {
        header('Location: ' . $config['success_redirect']);
        exit;
    }
} catch (Exception $e) {
    // Log do erro
    error_log("Erro ao enviar email de contato: {$mail->ErrorInfo} - IP: " . $_SERVER['REMOTE_ADDR'], 0);

    $error_message = 'Erro interno do servidor. Nossa equipe foi notificada.';

    if (isAjaxRequest()) {
        sendJsonResponse(false, $error_message, ['error_code' => 'SMTP_ERROR']);
    } else {
        header('Location: ' . $config['error_redirect'] . '&msg=' . urlencode($error_message));
        exit;
    }
}

// Fun√ß√£o de email de confirma√ß√£o para o cliente
function sendConfirmationEmail($cliente_email, $cliente_nome, $config)
{
    try {
        $mail = new PHPMailer(true);

        // Mesmas configura√ß√µes SMTP
        $mail->isSMTP();
        $mail->Host = $config['smtp_host'];
        $mail->SMTPAuth = true;
        $mail->Username = $config['smtp_username'];
        $mail->Password = $config['smtp_password'];
        $mail->SMTPSecure = $config['smtp_secure'];
        $mail->Port = $config['smtp_port'];
        $mail->CharSet = 'UTF-8';

        $mail->setFrom($config['from_email'], $config['from_name']);
        $mail->addAddress($cliente_email, $cliente_nome);

        $mail->isHTML(true);
        $mail->Subject = '‚úÖ Confirma√ß√£o - Sua mensagem foi recebida - MegaTech';

        $mail->Body = '
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa;">
            <div style="background: #2c3e50; color: white; padding: 25px; text-align: center; border-radius: 8px 8px 0 0;">
                <h1 style="margin: 0; font-size: 24px;">‚úÖ Mensagem Recebida!</h1>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Confirma√ß√£o autom√°tica</p>
            </div>
            
            <div style="padding: 30px; background: white;">
                <p style="font-size: 16px; margin-bottom: 20px;">Ol√° <strong>' . htmlspecialchars($cliente_nome) . '</strong>,</p>
                
                <p>Recebemos sua mensagem e nossa equipe analisar√° seu contato com aten√ß√£o.</p>
                <p><strong style="color: #27ae60;">Responderemos em at√© 24 horas!</strong></p>
                
                <div style="background: #e8f5e8; padding: 20px; margin: 25px 0; border-radius: 8px; border-left: 4px solid #27ae60;">
                    <h3 style="margin-top: 0; color: #2c3e50;">üìû Nossos Contatos:</h3>
                    <p style="margin: 8px 0;"><strong>üì± Telefone/WhatsApp:</strong> (44) 99801-1086</p>
                    <p style="margin: 8px 0;"><strong>üìß E-mail:</strong> contato@megatech.com.br</p>
                    <p style="margin: 8px 0;"><strong>üìç Endere√ßo:</strong> Av. Brasil - Centro, Campina da Lagoa/PR</p>
                    <p style="margin: 8px 0;"><strong>üïê Hor√°rio:</strong> Seg-Sex: 8h-18h | S√°b: 8h-12h</p>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 25px;">
                    <h4 style="margin-top: 0; color: #2c3e50;">üåü Siga-nos nas redes sociais:</h4>
                    <p style="margin-bottom: 0;">
                        <a href="https://www.instagram.com/megatech_cdl/" style="color: #e1306c; text-decoration: none; margin-right: 15px;">üì∑ Instagram</a>
                        <a href="https://www.facebook.com/MegaTech2k21/" style="color: #1877f2; text-decoration: none;">üìò Facebook</a>
                    </p>
                </div>
                
                <p style="margin-top: 25px; text-align: center; color: #7f8c8d;">
                    Obrigado por escolher a <strong style="color: #2c3e50;">MegaTech</strong>!
                </p>
            </div>
            
            <div style="background: #2c3e50; color: white; padding: 15px; text-align: center; font-size: 12px; border-radius: 0 0 8px 8px;">
                <p style="margin: 0;">Este √© um e-mail autom√°tico. N√£o responda a esta mensagem.</p>
                <p style="margin: 5px 0 0 0;">¬© ' . date('Y') . ' MegaTech - Todos os direitos reservados</p>
            </div>
        </div>';

        $mail->AltBody = "Ol√° $cliente_nome!\n\n"
            . "Recebemos sua mensagem e entraremos em contato em at√© 24 horas.\n\n"
            . "Nossos contatos:\n"
            . "Telefone: (44) 99801-1086\n"
            . "E-mail: contato@megatech.com.br\n"
            . "Endere√ßo: Av. Brasil - Centro, Campina da Lagoa/PR\n\n"
            . "Obrigado por escolher a MegaTech!";

        $mail->send();
        return true;
    } catch (Exception $e) {
        error_log("Erro ao enviar confirma√ß√£o para $cliente_email: {$mail->ErrorInfo}", 0);
        return false;
    }
}
